name: poetry-update

on:
  schedule:
    - cron: "0 9 * * 2" # Tuesday Mondays at 9AM
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
        with:
          persist-credentials: false # otherwise, the token used is the GITHUB_TOKEN, instead of your personal access token.

      - name: Install poetry
        run: pipx install poetry==1.7.1
      - uses: actions/setup-python@v3
        with:
          python-version: "3.10"

      - uses: fredrikaverpil/poetry-update@v1.2

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v4
        with:
          delete-branch: true
          branch: poetry-update
          add-paths: poetry.lock
          commit-message: "Update dependencies in `poetry.lock`"
          title: "[auto] Update dependencies in `poetry.lock`"
          draft: true
          body: |

            ### Updated dependencies:

            ```bash
            ${{ env.POETRY_UPDATED }}
            ```

            ### Outdated dependencies _before_ PR:

            ```bash
            ${{ env.POETRY_OUTDATED_BEFORE }}
            ```

            ### Outdated dependencies _after_ PR:

            ```bash
            ${{ env.POETRY_OUTDATED_AFTER }}
            ```

            _Note: there may be dependencies in the table above which were not updated as part of this PR.
            The reason is they require manual updating due to the way they are pinned._
