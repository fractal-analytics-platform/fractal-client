name: ci

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:

  tests:
    name: "Python ${{ matrix.python-version }}"
    runs-on: ubuntu-20.04
    timeout-minutes: 30

    strategy:
      matrix:
        python-version: ["3.8"]

    steps:

      - name: Clone fractal-analytics-platform/fractal-server  PUBLIC repository
        uses: GuillaumeFalourd/clone-github-repo-action@v2
        with:
          owner: 'fractal-analytics-platform'
          repository: 'fractal-server'

      - name: Git clone A
        run: |
          git clone -- https://github.com/fractal-analytics-platform/fractal-server.git /tmp/some-clone
          ls -l /tmp/some-clone

      - name: Git clone B
        run: |
          git clone --recurse-submodules -- https://github.com/fractal-analytics-platform/fractal-server.git /tmp/some-other-clone
          ls -l /tmp/some-other-clone

      - uses: actions/checkout@v3
        with:
          submodules: "recursive"
          fetch-depth: 1

      - name: Install poetry
        run: pipx install poetry==1.3


      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: "poetry"

      - name: Install dependencies
        run: poetry install --with dev --without docs --no-interaction
