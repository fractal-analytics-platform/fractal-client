services:
  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=fractal_client
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  fractal-server:
    image: python:${FRACTAL_SERVER_PYTHON:?FRACTAL_SERVER_PYTHON environment variable is required}-slim
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; import sys; sys.exit(0 if urllib.request.urlopen('http://localhost:${FRACTAL_SERVER_PORT:-8765}/api/alive/').getcode() == 200 else 1)"]
      interval: 4s
      timeout: 5s
      retries: 15
      start_period: 90s
    ports:
      - "${FRACTAL_SERVER_PORT:-8765}:${FRACTAL_SERVER_PORT:-8765}"
    environment:
      - FRACTAL_SERVER_VERSION=${FRACTAL_SERVER_VERSION:?FRACTAL_SERVER_VERSION environment variable is required}
      - FRACTAL_SERVER_PORT=${FRACTAL_SERVER_PORT:-8765}
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=fractal_client
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - ADMIN_EMAIL=admin@example.org
      - ADMIN_PWD=1234
      - ADMIN_PROJECT_DIR=/tmp/projects
      - FRACTAL_RUNNER_BACKEND=local
      - JWT_SECRET_KEY=secret_key
      - FRACTAL_TASKS_DIR=/tmp/tasks
      - FRACTAL_RUNNER_WORKING_BASE_DIR=/tmp/runner
      - FRACTAL_LOGGING_LEVEL=0
      - FRACTAL_DEFAULT_GROUP_NAME=All
    command: >
      bash -c "
        pip install fractal-server==$${FRACTAL_SERVER_VERSION} &&
        fractalctl set-db &&
        fractalctl init-db-data --resource default --profile default --admin-email \"$${ADMIN_EMAIL}\" --admin-pwd \"$${ADMIN_PWD}\" --admin-project-dir \"$${ADMIN_PROJECT_DIR}\" &&
        fractalctl start --host 0.0.0.0 --port \"$${FRACTAL_SERVER_PORT}\"
      "
