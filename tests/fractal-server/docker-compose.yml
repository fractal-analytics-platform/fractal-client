services:
  postgres:
    image: postgres:18
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=fractal_client
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  fractal-server:
    image: python:${FRACTAL_SERVER_PYTHON:-3.12}-slim
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "8765:8765"
    environment:
      - FRACTAL_SERVER_BRANCH=${FRACTAL_SERVER_BRANCH:-main}
      - FRACTAL_SERVER_PORT=8765
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB=fractal_client
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - ADMIN_EMAIL=admin@example.org
      - ADMIN_PWD=1234
      - ADMIN_PROJECT_DIR=/tmp/projects
      - FRACTAL_RUNNER_BACKEND=local
      - JWT_SECRET_KEY=secret_key
      - FRACTAL_TASKS_DIR=/tmp/tasks
      - FRACTAL_RUNNER_WORKING_BASE_DIR=/tmp/runner
      - FRACTAL_LOGGING_LEVEL=0
      - FRACTAL_DEFAULT_GROUP_NAME=All
    command: >
      bash -c "
        apt-get update && apt-get install -y git && python3 -m venv venv &&
        venv/bin/pip install git+https://github.com/fractal-analytics-platform/fractal-server.git@$${FRACTAL_SERVER_BRANCH} &&
        venv/bin/fractalctl set-db &&
        venv/bin/fractalctl init-db-data --resource default --profile default --admin-email \"$${ADMIN_EMAIL}\" --admin-pwd \"$${ADMIN_PWD}\" --admin-project-dir \"$${ADMIN_PROJECT_DIR}\" &&
        venv/bin/fractalctl start --host 0.0.0.0 --port \"$${FRACTAL_SERVER_PORT}\"
      "
